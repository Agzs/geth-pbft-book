## ç¼–è¯‘é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ³•

### 1ã€gorocksdbåŒ…é—®é¢˜
é€šè¿‡go get è·å–æœ€æ–°çš„gorocsdbï¼Œé‡åˆ°
```go
file: 'file:///home/zhiguo/go/src/github.com/tecbot/gorocksdb/db.go'
severity: 'Error'
message: '# github.com/tecbot/gorocksdb
could not determine kind of name for C.rocksdb_cache_get_pinned_usage
could not determine kind of name for C.rocksdb_cache_get_usage
'
at: '1,1'
source: ''
```
æŸ¥çœ‹[tecbot/gorocksdb](https://github.com/tecbot/gorocksdb)è¯´æ˜æ–‡æ¡£å‘ç°ï¼Œéœ€è¦åœ¨ç³»ç»Ÿä¸Šå…ˆ`build RocksDB v5.5+`.

æ ¹æ®[facebook/rocksdb](https://github.com/facebook/rocksdb/blob/master/INSTALL.md)å®‰è£…æ–‡æ¡£ï¼Œå‚è€ƒ[å®‰è£…rocksdbåšå®¢](http://www.cnblogs.com/shuren/p/3981744.html)ï¼Œå‘ç°ä»æœªè§£å†³é—®é¢˜ã€‚

æœ€ç»ˆä¸´æ—¶è§£å†³æ–¹æ³•ï¼šæ¯”è¾ƒæœ€æ–°çš„`tecbot/gorocksdb`(æœ‰49ä¸ªæ–‡ä»¶)å’Œ`fabric/vendor/github/tecbot/gorocksdb`(æœ‰29ä¸ªæ–‡ä»¶)ï¼Œå°è¯•åœ¨gopath/src/github.comç›®å½•ä¸‹ï¼Œåˆ é™¤æœ€æ–°çš„`tecbot/gorocksdb`ï¼Œç„¶åå¤åˆ¶ç²˜è´´`fabric/vendor/github`ç›®å½•ä¸‹tecbot/gorocksdb`ï¼Œ
æœ€ç»ˆé¡¹ç›®å¯è¿›è¡Œç¼–è¯‘ã€‚

åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­åˆé‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š
```go
github.com/tecbot/gorocksdb
github.com/yeongchingtarn/geth-pbft/core/db
github.com/yeongchingtarn/geth-pbft/consensus/pbft
github.com/yeongchingtarn/geth-pbft/eth
github.com/yeongchingtarn/geth-pbft/les
github.com/yeongchingtarn/geth-pbft/ethstats
github.com/yeongchingtarn/geth-pbft/contracts/release
github.com/yeongchingtarn/geth-pbft/cmd/utils
github.com/yeongchingtarn/geth-pbft/cmd/faucet
github.com/yeongchingtarn/geth-pbft/cmd/bootnode
# github.com/yeongchingtarn/geth-pbft/cmd/faucet
2017/10/27 09:18:08 duplicate symbol _cgoexp_4c7b26b16232_gorocksdb_compactionfilter_filter (types 1 and 1) in github.com/hyperledger/fabric/vendor/github.com/tecbot/gorocksdb and /home/ethtest/go/pkg/linux_amd64/github.com/tecbot/gorocksdb.a(_go_.o)
github.com/yeongchingtarn/geth-pbft/cmd/evm
# github.com/yeongchingtarn/geth-pbft/cmd/bootnode
2017/10/27 09:18:08 duplicate symbol _cgoexp_4c7b26b16232_gorocksdb_compactionfilter_filter (types 1 and 1) in github.com/hyperledger/fabric/vendor/github.com/tecbot/gorocksdb and /home/ethtest/go/pkg/linux_amd64/github.com/tecbot/gorocksdb.a(_go_.o)
github.com/yeongchingtarn/geth-pbft/cmd/geth
# github.com/yeongchingtarn/geth-pbft/cmd/evm
2017/10/27 09:18:09 duplicate symbol _cgoexp_4c7b26b16232_gorocksdb_compactionfilter_filter (types 1 and 1) in github.com/hyperledger/fabric/vendor/github.com/tecbot/gorocksdb and /home/ethtest/go/pkg/linux_amd64/github.com/tecbot/gorocksdb.a(_go_.o)
# github.com/yeongchingtarn/geth-pbft/cmd/geth
2017/10/27 09:18:09 duplicate symbol _cgoexp_4c7b26b16232_gorocksdb_compactionfilter_filter (types 1 and 1) in github.com/hyperledger/fabric/vendor/github.com/tecbot/gorocksdb and /home/ethtest/go/pkg/linux_amd64/github.com/tecbot/gorocksdb.a(_go_.o)
```
å‘ç°æŸäº›ç±»å‹é‡å¤

ä¸´æ—¶è§£å†³æ–¹æ³•ï¼šå°†`fabric/vendor/tecbot/gorocksdb`åˆ é™¤ï¼Œé¡¹ç›®å¯ç¼–è¯‘

### 2ã€å¯æ‰§è¡Œç¨‹åº
åœ¨`geth-pbft`ç›®å½•ä¸‹ï¼Œç»ˆç«¯è¿è¡Œ`go install ./cmd/geth`åªç”Ÿæˆgethå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œé€šè¿‡`go install ./...`ç¼–è¯‘æ‰€æœ‰çš„`geth-pbft`æ–‡ä»¶ï¼Œç”Ÿæˆä¸ƒä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼š`abigen`ã€`bootnode`ã€`evm`ã€`faucet`ã€`geth`ã€`puppeth`ã€`rlpdump`ï¼Œéƒ½ä½äº`gopath/bin`ç›®å½•ä¸‹ï¼Œå…¶ä¸­ä¼šç”¨åˆ°çš„æœ‰`geth`å’Œ`puppeth`

ä½†æ˜¯ï¼Œç³»ç»Ÿå­˜åœ¨ä¹‹å‰å®‰è£…çš„`geth`å’Œ`puppeth`ï¼Œä½äºusr/binç›®å½•ä¸‹ï¼Œå°†å…¶é€šè¿‡`sudo mv XXX /home/ethtest/gethexe`ç§»åŠ¨åˆ°å…¶ä»–ç›®å½•ä¸‹ã€‚å¦‚æœä¸è¿›è¡Œæ­¤æ“ä½œï¼Œåœ¨ç»ˆç«¯è¿è¡Œçš„`geth`å’Œ`puppeth`éƒ½æ˜¯ä¹‹å‰å®‰è£…çš„ç‰ˆæœ¬ï¼Œå¹¶éæœ¬æ¬¡ç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚

è‹¥è¦æµ‹è¯•ç¼–è¯‘ç”Ÿæˆçš„`geth`å’Œ`puppeth`ï¼Œå¯åœ¨`gopath/bin`ç›®å½•ä¸‹å°†å¯æ‰§è¡Œæ–‡ä»¶é‡å‘½åï¼Œæ¯”å¦‚`geth2`ã€`puppeth2`ï¼Œç„¶åè¿è¡Œã€‚

## è¿è¡Œé‡åˆ°çš„é—®é¢˜

è™½ç„¶ç¼–è¯‘é€šè¿‡ï¼Œç”Ÿæˆäº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯è¿è¡Œè¿‡ç¨‹ä¸­ä¾ç„¶ä¼šäº§ç”Ÿè®¸å¤šé—®é¢˜ã€‚

è§£å†³æ–¹æ³•ï¼šæ ¹æ®å‘½ä»¤è¡Œç»ˆç«¯æç¤ºï¼Œæ‰¾åˆ°æºç æ‰€åœ¨ä½ç½®ï¼Œè¿›è¡Œä¿®æ”¹ï¼Œä¿å­˜ï¼Œé‡æ–°ç¼–è¯‘ã€‚

æ¯”å¦‚ï¼Œä¸‹é¢è¿™å‡ ä¸ªé”™è¯¯ï¼š
### 1 `panic: runtime error: invalid memory address or nil pointer dereference`
* ä¾‹ä¸€ã€èµ‹å€¼æ“ä½œ
```go
    pb.pbft.helper.manager = pb.manager //=> add helper.manager --Agzs		
    configV := loadConfig()                           //=>replace configV in New()  prams. --Agzs

    pb.pbft = newPbftCore(id, configV, etf, com, fin)
```
å‘ç°pb.pbftåœ¨æœªè¢«åˆå§‹åŒ–çš„æƒ…å†µä¸‹è¿›è¡Œäº†èµ‹å€¼ï¼Œå¯¼è‡´äº†ç©ºæŒ‡é’ˆé”™è¯¯ã€‚è§£å†³æ–¹æ³•ï¼šå°†èµ‹å€¼è¯­å¥ç§»åˆ°pbftåˆå§‹åŒ–ä¸‹æ–¹ã€‚

ä¾‹äºŒã€openChainDB.DB.Get()
åœ¨è¿è¡Œ`geth --datadir ./data --networkid 55661  --port 2000 console`æŒ‡ä»¤æ—¶ï¼Œæç¤ºé”™è¯¯å¦‚ä¸‹ï¼š
```go
github.com/tecbot/gorocksdb.(*DB).GetCF(0x0, 0xc42000e190, 0x0, 0xc4202edd50, 0xe, 0x10, 0x0, 0x0, 0x0)
	/home/ethtest/go/src/github.com/tecbot/gorocksdb/db.go:258 +0xb6
github.com/yeongchingtarn/geth-pbft/core/db.(*OpenchainDB).Get(0xc4203bf200, 0x0, 0xc4202edd50, 0xe, 0x10, 0x0, 0x0, 0x0, 0x0, 0x0)
	/home/ethtest/go/src/github.com/yeongchingtarn/geth-pbft/core/db/db.go:255 +0xf0
github.com/yeongchingtarn/geth-pbft/consensus/pbft.(*databaseHelper).ReadState(0xc420404f38, 0x1045a50, 0x4, 0x439096, 0x0, 0x0, 0xc4204ad990, 0x4a8edc)
	/home/ethtest/go/src/github.com/yeongchingtarn/geth-pbft/consensus/pbft/persist.go:49 +0xc3
```
æ ¹æ®æç¤ºï¼Œæ‰¾åˆ°å¦‚ä¸‹æºç ï¼š
```go
// ReadState retrieves a value to a key
func (h *databaseHelper) ReadState(key string) ([]byte, error) {
	db := db.GetDBHandle()
	return db.Get(db.PersistCF, []byte("consensus."+key))
}
func create() *OpenchainDB {
	return &OpenchainDB{}
}
func (openchainDB *OpenchainDB) Get(cfHandler *gorocksdb.ColumnFamilyHandle, key []byte) ([]byte, error) {
	...
	slice, err := openchainDB.DB.GetCF(opt, cfHandler, key)
	...
}
```
å‘ç°`openchainDB`å¹¶æ²¡æœ‰åˆå§‹åŒ–,å¯¼è‡´`openchainDB.DB`ä¸ºç©ºæŒ‡é’ˆ
è§£å†³æ–¹æ³•ï¼šé€šè¿‡ç ”ç©¶æºç å‘ç°ï¼ŒopenchainDBåœ¨db.goçš„Start()å‡½æ•°ä¸­ï¼Œé€šè¿‡å±‚å±‚è°ƒç”¨è¿›è¡Œäº†åˆå§‹åŒ–ï¼Œæ‰€ä»¥åœ¨geth-pbft/eth/backend.goçš„New()ä¸­æ·»åŠ äº†db.Start()ï¼Œvscodeå¯èƒ½ä¼šè‡ªåŠ¨æ·»åŠ import "github.com/hyperledger/fabric/core/db"ï¼Œæˆ‘ä»¬è¦æ”¹æˆ"github.com/yeongchingtarn/geth-pbft/core/db"ï¼Œä¿å­˜ï¼Œé‡æ–°ç¼–è¯‘ï¼Œåˆé‡åˆ°é”™è¯¯ğŸ˜­ï¼Œ`panic: DB path not specified in configuration file. Please check that property 'peer.fileSystemPath' is set`ã€‚

### 2 `panic: DB path not specified in configuration file. Please check that property 'peer.fileSystemPath' is set`
æ ¹æ®æç¤ºï¼Œæ‰¾åˆ°æºç ï¼š
```go
func getDBPath() string {
	dbPath := viper.GetString("peer.fileSystemPath")
	if dbPath == "" {
		panic("DB path not specified in configuration file. Please check that property 'peer.fileSystemPath' is set")
	}
	if !strings.HasSuffix(dbPath, "/") {
		dbPath = dbPath + "/"
	}
	return dbPath + "db"
}
```
fabric/peer/core.yamlæ–‡ä»¶ä¸­æœ‰å…³äº`peer.fileSystemPath`çš„å®šä¹‰ï¼š
```go
###############################################################################
#
#    Peer section
#
###############################################################################
peer:
    ...
    # Path on the file system where peer will store data
    fileSystemPath: /var/hyperledger/production
    # rocksdb configurations
    db:
        maxLogFileSize: 10485760
        keepLogFileNum: 10
        logLevel: "warn"

    profile:
        enabled:     false
        listenAddress: 0.0.0.0:6060

```
çŒœæƒ³å¯èƒ½æ˜¯viperè·¯å¾„é—®é¢˜ï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š
* 1) geth-pbft/node/core.yaml

å‚è€ƒfabric/peer/core.yamlæ–‡ä»¶ï¼Œæ·»åŠ .yamlæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š
```go
peer:
    # Path on the file system where peer will store data
    fileSystemPath: /home/ethtest/hyperledgerRocksDB/data # //=> should be changed for different OS. --Agzs
    # rocksdb configurations
    db:
        maxLogFileSize: 10485760
        keepLogFileNum: 10
        logLevel: "warn"

    profile:
        enabled:     false
        listenAddress: 0.0.0.0:6060
```
æ³¨ï¼šç”±äºæ— æ³•åœ¨`computer`ç›®å½•ä¸‹åˆ›å»ºå…¶ä»–æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥é‡‡å–åœ¨`home/ethtest`ç›®å½•ä¸‹ä¿å­˜`rocksdb`æ–‡ä»¶ï¼Œ`fileSystemPath`éœ€æ ¹æ®ä¸åŒçš„ç³»ç»Ÿè´¦æˆ·è¿›è¡Œè®¾ç½®ï¼Œæˆ‘çš„è´¦æˆ·ä¸º`ethtest`ã€‚

* 2) ä¿®æ”¹geth-pbftä¸­æ‰€æœ‰çš„rocksdbåŒ…çš„å¯¼å…¥è·¯å¾„

å°†æ‰€æœ‰çš„`"github.com/hyperledger/fabric/core/db"`æ”¹ä¸º`"github.com/yeongchingtarn/geth-pbft/core/db"`

* 3) geth-pbft/cmd/geth/main.go

åœ¨è¯¥æ–‡ä»¶ä¸‹çš„init()å‡½æ•°ä¸­æ·»åŠ viperçš„åˆå§‹åŒ–ï¼Œå¦‚ä¸‹ï¼š
```go
func init() {
	//=> init viper. --Agzs
	viper.SetEnvPrefix(cmdRoot)
	viper.AutomaticEnv()
	var alternativeCfgPath = os.Getenv("PEER_CFG_PATH")
	if alternativeCfgPath != "" {
		logger.Infof("User defined config file path: %s", alternativeCfgPath)
		viper.AddConfigPath(alternativeCfgPath) // Path to look for the config file in
	} else {
		viper.AddConfigPath("./") // Path to look for the config file in
		// Path to look for the config file in based on GOPATH
		gopath := os.Getenv("GOPATH")
		for _, p := range filepath.SplitList(gopath) {
			peerpath := filepath.Join(p, "src/github.com/yeongchingtarn/geth-pbft/node")
			viper.AddConfigPath(peerpath)
		}
	}

	// Now set the configuration file.
	viper.SetConfigName(cmdRoot) // Name of config file (without extension)

	err := viper.ReadInConfig() // Find and read the config file
	if err != nil {             // Handle errors reading the config file
		panic(fmt.Errorf("Fatal error when reading %s config file: %s\n", cmdRoot, err))
	}
	...
}
```
* 4) ä¿å­˜ï¼Œé‡æ–°ç¼–è¯‘ï¼Œè¿è¡Œ

* è¿è¡Œç»“æœ

å‘ç°å•ä¸€ç»ˆç«¯è¿è¡ŒæˆåŠŸï¼Œä½†æ˜¯å¤šä¸ªç»ˆç«¯è¿è¡Œæç¤ºæ–‡ä»¶ä¸Šé”ï¼š
```go
ethtest@aguan-VirtualBox:~/pbft/signer2$ geth --datadir ./data --networkid 55661 --port 2003 --unlock 426f88a7fda6bdb3ef2647214e5c4107a5ead6ff console
INFO [10-30|08:58:21] Starting peer-to-peer node               instance=Geth/v1.6.7-stable/linux-amd64/go1.8
2017/10/30 08:58:21 Is db path [/home/ethtest/hyperledgerRocksDB/data/db] empty [false]
2017/10/30 08:58:21 Setting rocksdb maxLogFileSize to 10485760
2017/10/30 08:58:21 Setting rocksdb keepLogFileNum to 10
2017/10/30 08:58:21 Setting rocks db InfoLogLevel to 2
panic: Error opening DB: IO error: lock /home/ethtest/hyperledgerRocksDB/data/db/LOCK: Resource temporarily unavailable

goroutine 1 [running]:
github.com/yeongchingtarn/geth-pbft/core/db.(*OpenchainDB).open(0xc4203a1da0)
	/home/ethtest/go/src/github.com/yeongchingtarn/geth-pbft/core/db/db.go:201 +0x886
github.com/yeongchingtarn/geth-pbft/core/db.Start()
	/home/ethtest/go/src/github.com/yeongchingtarn/geth-pbft/core/db/db.go:77 +0x2d
...
```
ç›®å‰æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š
* 1ï¼‰é‡‡å–é˜¿é‡Œäº‘ï¼Œéƒ¨ç½²å¤šä¸ªç»ˆç«¯(è‡³å°‘4ä¸ªï¼‰ï¼Œè¿›è¡Œæµ‹è¯•ã€‚

ç›®å‰è®¾å¤‡æ•°ä¸è¶³ï¼Œæš‚æ—¶æœªé‡‡å–ã€‚
* 2ï¼‰ä»¿ç…§levelDBåœ¨åŒä¸€ç»ˆç«¯ä¸‹åˆ†æ–‡ä»¶å¤¹ä¿å­˜å„è‡ªDBã€‚

æ‰“ç®—ç¼–è¯‘ç”Ÿæˆå››ä¸ªgethå¯æ‰§è¡Œç¨‹åºï¼Œç¼–å·0ã€1ã€2ã€3ï¼Œå„è‡ªä½¿ç”¨è‡ªå·±çš„core.yamlæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„fileSystemPathå„è‡ªè®¾ç½®ã€‚ç„¶åè¿›è¡Œæ“ä½œã€‚å¤§æ¦‚éœ€è¦å…­ä¸ªç»ˆç«¯ï¼Œå››ä¸ªç”¨ä½œVPï¼Œä¸¤ä¸ªç”¨ä½œNode(è¿›è¡Œäº¤æ˜“)

ç›®å‰æ­£åœ¨æµ‹è¯•ç¬¬äºŒç§æ–¹æ³•ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
### 3 ä¹±ç é—®é¢˜
```go
> miner.start()
INFO [10-30|11:33:48] Transaction pool price threshold updated price=18000000000
null
> INFO [10-30|11:33:48] Starting mining operation 
INFO [10-30|11:33:48] Commit new mining work                   number=1 txs=0 uncles=0 elapsed=334.103Âµs
ï¿½GU10/30 11:33:48 Replica 0 received a block ï¿½jï¿½^#ï¿½ï¿½4Eï¿½^ï¿½>ï¿½ï¿½ï¿½V9ï¿½ï¿½ï¿½
ï¿½GU10/30 11:33:48 Replica 0 soft starting new view timer for 2s: new block ï¿½jï¿½^#ï¿½ï¿½4Eï¿½^ï¿½>ï¿½ï¿½ï¿½V9ï¿½ï¿½ï¿½
ï¿½GU10/30 11:33:48 Replica 0 is primary, issuing pre-prepare for block ï¿½jï¿½^#ï¿½ï¿½4Eï¿½^ï¿½>ï¿½ï¿½ï¿½V9ï¿½ï¿½ï¿½
2017/10/30 11:33:48 Primary 0 broadcasting pre-prepare for view=0/seqNo=2 and digest ï¿½jï¿½^#ï¿½ï¿½4Eï¿½^ï¿½>ï¿½ï¿½ï¿½Vï¿½GU
2017/10/30 11:33:48 Starting timer
2017/10/30 11:33:48 Replica 0 prepare count for view=0/seqNo=2: 0
2017/10/30 11:33:48 Attempting to stop an unfired idle timer
2017/10/30 11:33:48 Stopping timer
2017/10/30 11:33:50 Event timer fired
2017/10/30 11:33:50 Timer event delivered
2017/10/30 11:33:50 Replica 0 batch main thread looping
2017/10/30 11:33:50 Replica 0 processing event
2017/10/30 11:33:50 Replica 0 view change timer expired, sending view change: new block ï¿½jï¿½^#ï¿½ï¿½4Eï¿½^ï¿½>ï¿½ï¿½GUï¿½ï¿½
2017/10/30 11:33:50 Replica 0 stopping a running new view timer
2017/10/30 11:33:50 Replica 0 prepare count for view=0/seqNo=2: 0
2017/10/30 11:33:50 Attempting to stop an unfired idle timer
2017/10/30 11:33:50 Stopping timer
```
è§£å†³æ–¹æ³•ï¼š

åœ°å€ç±»å‹addressï¼Œå¦‚æœéœ€è¦è¾“å‡ºçš„è¯éœ€è¦`%x`æ ¼å¼è¾“å‡ºï¼Œä¾‹å¦‚`fmt.Sprintf("new block %x", digest)`

è‹¥åœ¨ç»ˆç«¯æ‰“å°æç¤ºè¯­å¥ï¼Œå¯é‡‡ç”¨go-etheren/logåŒ…é‡Œçš„å‡½æ•°ï¼Œlog.Info("æç¤ºè¯­"ï¼Œ "å˜é‡å1",å˜é‡å1,"å˜é‡å2",å˜é‡å2)ï¼Œæ¯”å¦‚ï¼š

`log.Info("Replica is primary, issuing pre-prepare for block", "Replica(PeerID)", instance.id, "hash", common.BytesToHash(digest))`

è¾“å‡ºçš„æ•ˆæœï¼š

`INFO [11-03|21:57:45] Replica is primary, issuing pre-prepare for block Replica(PeerID)=0 hash=6c500dâ€¦45b211`

### 4ã€æ—¶é—´æœºåˆ¶orå¹¿æ’­ï¼Ÿ
```go
> miner.start()
INFO [10-30|20:26:55] Transaction pool price threshold updated price=18000000000
nullINFO [10-30|20:26:55] Starting mining operation 

> INFO [10-30|20:26:55] Commit new mining work                   number=1 txs=0 uncles=0 elapsed=111.914Âµs
2017/10/30 20:26:55 Replica 0 received a block ï¿½ï¿½ß’ï¿½Mï¿½>ï¿½ï¿½Rï¿½ï¿½Sï¿½$KWï¿½ï¿½ï¿½<pï¿½ï¿½G"ï¿½ï¿½Xï¿½
2017/10/30 20:26:55 Replica 0 soft starting new view timer for 20s: new block ï¿½ï¿½ß’ï¿½Mï¿½>ï¿½ï¿½Rï¿½ï¿½Sï¿½$KWï¿½ï¿½ï¿½<pï¿½ï¿½G"ï¿½ï¿½Xï¿½
2017/10/30 20:26:55 Replica 0 is primary, issuing pre-prepare for block ï¿½ï¿½ß’ï¿½Mï¿½>ï¿½ï¿½Rï¿½ï¿½Sï¿½$KWï¿½ï¿½ï¿½<pï¿½ï¿½G"ï¿½ï¿½Xï¿½
2017/10/30 20:26:55 Primary 0 broadcasting pre-prepare for view=0/seqNo=5 and digest ï¿½ï¿½ß’ï¿½Mï¿½>ï¿½ï¿½Rï¿½ï¿½Sï¿½$KWï¿½ï¿½ï¿½<pï¿½ï¿½G"ï¿½ï¿½Xï¿½
2017/10/30 20:26:55 Starting timer
2017/10/30 20:26:55 Replica 0 prepare count for view=0/seqNo=5: 0
2017/10/30 20:26:55 Attempting to stop an unfired idle timer
2017/10/30 20:26:55 Stopping timer
2017/10/30 20:27:15 Event timer fired
2017/10/30 20:27:15 Timer event delivered
2017/10/30 20:27:15 Replica 0 batch main thread looping
2017/10/30 20:27:15 Replica 0 processing event
2017/10/30 20:27:15 Replica 0 view change timer expired, sending view change: new block ï¿½ï¿½ß’ï¿½Mï¿½>ï¿½ï¿½Rï¿½ï¿½Sï¿½$KWï¿½ï¿½ï¿½<pï¿½ï¿½G"ï¿½ï¿½Xï¿½
2017/10/30 20:27:15 Replica 0 stopping a running new view timer
2017/10/30 20:27:15 Replica 0 prepare count for view=0/seqNo=5: 0
2017/10/30 20:27:15 Attempting to stop an unfired idle timer
2017/10/30 20:27:15 Stopping timer

> miner.stop()
INFO [10-30|20:32:35] Stop PBFT algorithm! 

```

åŸå› ï¼šç”±äºé¡¹ç›®ä»pbft/config.yamlè¯»å–æ•°æ®ï¼Œconfig.yamlä¸­å…³äºæ—¶é—´è®¾ç½®å¦‚ä¸‹ï¼š
```go
timeout:

        # Send a pre-prepare if there are pending requests, batchsize isn't reached yet,
        # and this much time has elapsed since the current batch was formed
        batch: 1s

        # How long may a request take between reception and execution, must be greater than the batch timeout
        request: 2s

        # How long may a view change take
        viewchange: 2s

        # How long to wait for a view change quorum before resending (the same) view change
        resendviewchange: 2s

        # Interval to send "keep-alive" null requests.  Set to 0 to disable. If enabled, must be greater than request timeout
        nullrequest: 0s

        # How long may a message broadcast take.
        broadcast: 1s
```

è§£å†³æ–¹æ³•ï¼šå°†ä¸Šè¿°æ—¶é—´æ‰©å¤§10å€ï¼Œç”¨äºæµ‹è¯•ï¼Œ**åæœŸåœ¨è¿›è¡Œä¿®æ”¹**...

### 5ã€åŒä¸€ä¸»èŠ‚ç‚¹ç»ˆç«¯ï¼Œæç¤ºé”™è¯¯
```go
> miner.start()
INFO [10-30|20:32:41] Transaction pool price threshold updated price=18000000000
null
INFO [10-30|20:32:41] Starting mining operation 
> INFO [10-30|20:32:41] Commit new mining work                   number=1 txs=0 uncles=0 elapsed=100.888Âµs
WARN [10-30|20:32:41] Block sealing failed                     err="not primary note, cannot issue Seal"
> miner.stop()
true
```
ä¸»èŠ‚ç‚¹miner.stop()åé‡æ–°miner.start()ï¼Œæç¤ºä¸Šè¿°é”™è¯¯ï¼Œåˆæ­¥åˆ¤å®šå½“å‰ä¸»èŠ‚ç‚¹çš„æ—¶é—´æœºåˆ¶è§¦å‘viewchangeï¼Œè€Œå…¶ä»–VPæœªæ”¶åˆ°viewchangeï¼Œå½“å‰ä¸»èŠ‚ç‚¹çš„viewå˜åŒ–ï¼Œå¯¼è‡´åœ¨æ–°çš„viewä¸­ä¸»èŠ‚ç‚¹ä¸å†æ˜¯å½“å‰çš„ä¸»èŠ‚ç‚¹ï¼Œå¾…è§£å†³ã€‚






### 6ã€pbftMessageæ— æ³•å¹¿æ’­å‡ºå»

å½“`commChan`ä¸­äº§ç”Ÿæ–°æ¶ˆæ¯æ—¶ï¼Œ`protocolManager`ä¼šè°ƒç”¨`BroadcastMsg()`ï¼Œè¯¥å‡½æ•°å¦‚ä¸‹ï¼š
```go
func (pm *ProtocolManager) BroadcastMsg(msg *types.PbftMessage) {
	
	/// TODO: May need to optimize it, only broadcast msg to peers without it. --Zhiguo
	///	peers := pm.peers.PeersWithoutTx(hash)
	//FIXME include this again: peers = peers[:int(math.Sqrt(float64(len(peers))))]
	
	//=> add PeerWithoutMsg() start. --Agzs
	hash := types.Hash(msg)
	peers := pm.peers.PeersWithoutMsg(hash)

	for _, peer := range peers {
		log.Info("peer broadcast msg", "peer", peer.id, "send msg's hash:", hash) //=>test. --Agzs
		peer.SendMsg(msg)
	}

	log.Trace("Broadcast transaction", "hash", hash, "recipients", len(pm.peers.peers)) //=> peers ->  pm.peers.peers --Agzs
}
```
è¯¥å‡½æ•°ä¼šå¯¹åŠ å…¥åˆ°p2pçš„æ¯ä¸ªpeerè°ƒç”¨SendMsg()ï¼Œæœ€ç»ˆä¼šè°ƒç”¨go-ethereum/p2pä¸­`Send(p.rw, ConsensusMsg, msg)`ï¼Œé€šè¿‡æ‰“å°æ•°æ®å‘ç°
æ­¤æ—¶ï¼Œå¹¶æ²¡æœ‰çœŸæ­£å‘é€å‡ºå»ï¼Œæ­¤è¿‡ç¨‹è¿˜æ¶‰åŠåˆ°rlpç¼–ç ï¼›Send()å‡½æ•°æœ€ç»ˆä¼šåœ¨`ethereum/go-ethereum/rlp/typecache.go`ä¸­`genTypeInfo()`å‡½æ•°å†…è°ƒç”¨`makeDecoder()`å’Œ`makeWriter()`.

```go
func makeDecoder(typ reflect.Type, tags tags) (dec decoder, err error) {
	kind := typ.Kind()
	log.Info(" makeDecoder --start--", "typeName", kind) //=>test. --Agzs
	switch {
	case typ == rawValueType:
		return decodeRawValue, nil
	case typ.Implements(decoderInterface):
		return decodeDecoder, nil
	case kind != reflect.Ptr && reflect.PtrTo(typ).Implements(decoderInterface):
		return decodeDecoderNoPtr, nil
	case typ.AssignableTo(reflect.PtrTo(bigInt)):
		return decodeBigInt, nil
	case typ.AssignableTo(bigInt):
		return decodeBigIntNoPtr, nil
	case isUint(kind):
		return decodeUint, nil
	case kind == reflect.Bool:
		return decodeBool, nil
	case kind == reflect.String:
		return decodeString, nil
	case kind == reflect.Slice || kind == reflect.Array:
		return makeListDecoder(typ, tags)
	case kind == reflect.Struct:
		return makeStructDecoder(typ)
	case kind == reflect.Ptr:
		if tags.nilOK {
			return makeOptionalPtrDecoder(typ)
		}
		return makePtrDecoder(typ)
	case kind == reflect.Interface:
		return decodeInterface, nil
	// case kind == reflect.Map: //=>TODO. --Agzs
	// 	return nil, nil
	default:
		log.Info(" makeDecoder --default--", "typeName", kind) //=>test. --Agzs
		return nil, fmt.Errorf("rlp: type %v is not RLP-serializable", typ)
	}
}
```
* åŸå› ï¼š

1ï¼‰`msg.code`å’Œ`protoclLength`é—®é¢˜ï¼Œå­¦å§å·²è§£å†³,å®é™…ä¸Šåªéœ€è¦å¯¹eth63ç‰ˆæœ¬çš„é•¿åº¦+1å°±è¡Œï¼Œeth62ç‰ˆæœ¬é•¿åº¦ä»ç„¶æ˜¯8ã€‚åæœŸæ·»åŠ æ–°çš„ç¼–å·æ—¶ï¼Œeth63çš„é•¿åº¦éœ€è¦åŠ ç›¸åº”çš„ä¸ªæ•°ã€‚

2)ç”±äº`types.PbftMessage`æ‰€åŒ…å«çš„æˆå‘˜å˜é‡å­˜åœ¨switchåˆ†æ”¯ä¸­æœªå®šä¹‰çš„ç±»å‹ï¼Œæ‰€ä»¥å°†åŒ¹é…defaultåˆ†æ”¯,æœ€ç»ˆä¼šè¿”å›é”™è¯¯ã€‚

* è§£å†³æ–¹æ³•ï¼š

é‡æ–°å®šä¹‰äº†types.PbftMessageçš„ç»“æ„ä½“ï¼Œå¥½åƒä¸ç”¨ä¿®è¯¥è¿™éƒ¨åˆ†ç»“æ„ä½“ä¹Ÿå¯ä»¥.

åœ¨NewViewä¸­çš„XSetæˆå‘˜å˜é‡ä¸º`map[uint64]string`ç±»å‹ï¼Œè€Œ`makeDecoder()`çš„switchåˆ†æ”¯ä¸­å¹¶æ²¡æœ‰reflect.Mapï¼Œå¦‚æœæ–°å¢åŠ è¯¥åˆ†æ”¯çš„è¯ï¼Œéœ€è¦è‡ªå·±ç¼–å†™ç›¸å…³çš„decoderå‡½æ•°ï¼Œæ¶‰åŠå…ƒæ•°æ®ï¼Œå®¹æ˜“å‡ºé”™ï¼Œæ‰€ä»¥ç°åœ¨ä¸´æ—¶å°†Xsetç”±`map[uint64]string`å®šä¹‰ä¸º`[]*XSet`ç±»å‹ï¼Œæ¶‰åŠxsetçš„éƒ½éœ€è¦æ”¹å˜ï¼Œç”±äºä¿®æ”¹å†…å®¹æ¯”è¾ƒå¤šï¼Œåœ¨æ­¤ä¸è¯¦ç»†ä»‹ç»ï¼Œåœ¨[ä¿®æ”¹æ–‡ä»¶æ±‡æ€»11.5](https://github.com/Agzs/geth-pbft-study/wiki/%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%B1%87%E6%80%BB)ä¸­ä»‹ç»ã€‚

ä¿®æ”¹æœ¬éƒ¨åˆ†åï¼Œå…¶ä»–çš„signerå¯æ”¶åˆ°types.PbftMessageç±»å‹ï¼Œmsg.codeä¹Ÿä¸º17ï¼Œä½†æ˜¯å‡ºç°è§£ç é”™è¯¯é—®é¢˜(ä¸€ï¼‰

### 7ã€è§£ç é”™è¯¯é—®é¢˜(ä¸€ï¼‰
```go
//ä½äºethereum/go-ethereum/rlp/typecache.go
func (s *Stream) Decode(val interface{}) error {
	if val == nil {
		return errDecodeIntoNil
	}
	rval := reflect.ValueOf(val)
	rtyp := rval.Type()
	if rtyp.Kind() != reflect.Ptr {
		return errNoPointer
	}
	if rval.IsNil() {
		return errDecodeIntoNil
	}

	info, err := cachedTypeInfo(rtyp.Elem(), tags{})
	if err != nil {
		return err
	}

	err = info.decoder(s, rval.Elem()) //=> consensusMsg will call decodeInterface(s *Stream, val reflect.Value) --Agzs
	if decErr, ok := err.(*decodeError); ok && len(decErr.ctx) > 0 {
		// add decode target type to error so context has more meaning
		log.Info("stream.Decode() decErr") //=>test. --Agzs
		decErr.ctx = append(decErr.ctx, fmt.Sprint("(", rtyp.Elem(), ")"))
	}
	return err
}
```

æœªé‡æ–°å®šä¹‰types.PbftMessageå‰ï¼Œè¯¥éƒ¨åˆ†ä¸æŠ¥é”™ï¼Œå…¶ä¸­decoderä¼šè°ƒç”¨`decodeInterface(s *Stream, val reflect.Value)`

é‡æ–°å®šä¹‰ä¿®æ”¹åï¼Œä¼šæ‰§è¡Œ`log.Info("stream.Decode() decErr")`ï¼Œå‡ºç°decErré”™è¯¯ã€‚

* é—®é¢˜åŸå› å¦‚ä¸‹ï¼š

åœ¨æ–°ä¿®æ”¹çš„types.PbftMessageç»“æ„ä½“ä¸­ï¼Œå°†payloadæ¢æˆäº†preprepareã€prepare...ç­‰æŒ‡é’ˆï¼Œå¦‚æœè¦å‘é€çš„æ¶ˆæ¯æ˜¯ç›¸å…³ç±»å‹çš„æ¶ˆæ¯ï¼Œå°±èµ‹å€¼ç»™è¯¥æˆå‘˜å˜é‡ï¼Œå…¶ä»–æˆå‘˜å˜é‡ä¸ºnilï¼Œï¼ˆæ¯”å¦‚è¦å‘é€preprepï¼Œåˆ™types.PbftMessageçš„æˆå‘˜å˜é‡PrePrepareæŒ‡é’ˆæŒ‡å‘preprepï¼Œå…¶ä»–æˆå‘˜å˜é‡æŒ‡é’ˆéƒ½è®¾ç½®ä¸ºç©ºï¼‰ã€‚å½“æ—¶åªæ˜¯ä¸ºäº†è§£å†³æ¶ˆæ¯å‘é€é—®é¢˜ï¼Œæ²¡æƒ³åˆ°åœ¨è¿™å‡ºé”™äº†ã€‚ç”±äºæ–°ä¿®æ”¹çš„ç»“æ„ä½“types.PbftMessageä¸­åœ¨ä½¿ç”¨æ—¶å«æœ‰ç©ºæŒ‡é’ˆæ•°æ®ï¼Œæ‰€ä»¥ä¼šæŠ¥æ­¤é”™è¯¯ã€‚æ–°ä¿®æ”¹çš„ç»“æ„ä½“ç±»å‹å¦‚ä¸‹ï¼š
```go
type pbftMessage struct {
	PrePrepare *PrePrepare //=> payload = 1
	Prepare    *Prepare    //=> payload = 2
	Commit     *Commit     //=> payload = 3
	Checkpoint *Checkpoint //=> payload = 4
	ViewChange *ViewChange //=> payload = 5
	NewView    *NewView    //=> payload = 6
	//FetchBlockMsg *FetchBlockMsg //=> payload = 7
	Sender      uint64 //=>add. --Agzs
	PayloadCode uint64
	Payload     interface{}
}
```

* è§£å†³æ–¹æ³•ï¼š

é‡æ–°å®šä¹‰ç»“æ„ä½“ï¼Œå»é™¤æŒ‡é’ˆå®šä¹‰ï¼Œé‡‡ç”¨åŸå…ˆçš„payloadï¼Œå®šä¹‰ä¸ºæ¥å£ç±»å‹ï¼š
```go
type pbftMessage struct {
	Sender      uint64 //=>add. --Agzs
	PayloadCode uint64
	Payload     interface{}
}
```é—®é¢˜è§£å†³ï¼Œä¸»èŠ‚ç‚¹å¯ä»¥å‘é€æ¶ˆæ¯ï¼Œå…¶ä»–VPèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œå´å‡ºç°è§£ç é”™è¯¯é—®é¢˜(äºŒï¼‰

### 8ã€è§£ç é”™è¯¯é—®é¢˜(äºŒï¼‰ payload
ä¸»èŠ‚ç‚¹å¯ä»¥å‘é€æ¶ˆæ¯ï¼Œå…¶ä»–VPèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥è·å–åˆ°é™¤payloadä»¥å¤–çš„æ‰€æœ‰æ•°æ®ï¼Œå”¯ç‹¬æ— æ³•è¯†åˆ«payloadçš„çœŸå®ç±»å‹ï¼ˆæ¯”å¦‚PrePrepareï¼‰ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š
```go
panic: interface conversion: interface {} is []interface {}, not *types.PrePrepare
```
* åŸå› ï¼š

types.PbftMessageåœ¨p2pä¼ æ’­çš„æ—¶å€™è¢«è½¬æ¢æˆinteface{}ç±»å‹ï¼Œè€Œpayloadä½œä¸ºå…¶æˆå‘˜å˜é‡ä¹Ÿæ˜¯æ¥å£ç±»å‹ï¼Œç”±äºinterfaceçš„ç±»å‹è½¬æ¢æ¯”è¾ƒæ··ä¹±ï¼Œå‚è€ƒ[goï¼šinterface{}ã€æ–­è¨€ä¸ç±»å‹è½¬æ¢](http://www.cnblogs.com/xiaopipi/p/4889212.html)ï¼ŒRLPç¼–ç ä¼ å‚çš„ç±»å‹æ˜¯interfaceï¼Œåˆæ­¥çŒœæƒ³RLPå¯ä»¥ç¼–ç ï¼Œä½†æ˜¯è§£ç çš„æ—¶å€™ï¼Œæ— æ³•è¯»å–interfaceç±»å‹çš„æ•°æ®ã€‚

ethereumä¸­çš„blockå®šä¹‰ä¹Ÿæœ‰interface{}æˆå‘˜å˜é‡ï¼š`ReceivedFrom interface{}`ï¼Œä½†æ˜¯è¯¥å˜é‡å¹¶æœªé€šè¿‡ç¼–è§£ç ï¼Œè€Œæ˜¯é€šè¿‡`request.Block.ReceivedFrom = p`ï¼Œå…¶ä¸­pæ˜¯handleMsg(p *peer)ä¸­çš„å‚æ•°ã€‚

* è§£å†³æ–¹æ³•ï¼š

å°†`types.PbftMessage`ä¸­çš„payloadåœ¨p2på‘é€ä¹‹å‰è¯»å–å‡ºæ¥ï¼Œä½¿ç”¨å„è‡ªçš„msg.codeï¼Œåˆ†ç±»å‘é€ï¼›æ¥æ”¶ç«¯ï¼Œåˆ†ç±»å›æ”¶ï¼Œæœ€åç»„è£…æˆ`types.PbftMessage`ï¼Œç„¶åè¿›è¡Œäº‹ä»¶å¤„ç†ï¼Œå…·ä½“ä¿®æ”¹[ä¿®æ”¹æ–‡ä»¶æ±‡æ€»11.5](https://github.com/Agzs/geth-pbft-study/wiki/%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%B1%87%E6%80%BB)

### 9ã€sendViewChangeæŠ¥é”™
* æç¤ºé”™è¯¯ï¼š
```go
panic: runtime error: invalid memory address or nil pointer dereference
[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0xc93636]

goroutine 55 [running]:
github.com/yeongchingtarn/geth-pbft/consensus/pbft.(*pbftCore).sendViewChange(0xc4203d2000, 0x10aafe8, 0x3d)
	/home/zhiguo/go/src/github.com/yeongchingtarn/geth-pbft/consensus/pbft/viewchange.go:185 +0x736
github.com/yeongchingtarn/geth-pbft/consensus/pbft.(*pbftCore).ProcessEvent(0xc4203d2000, 0xf02820, 0x1a13f30, 0xc4216b9a60, 0x1)
	/home/zhiguo/go/src/github.com/yeongchingtarn/geth-pbft/consensus/pbft/pbft-core.go:373 +0xf37
```

* åŸå› ï¼šå…¶ä»–signeræœªå¯åŠ¨miner.start()ï¼Œå¯¼è‡´signerå’ŒsignFnæ²¡æœ‰åˆå§‹åŒ–èµ‹å€¼ï¼š

```go
func (s *Ethereum) StartMining(local bool) error {
	eb, err := s.Etherbase()
	...
	//=>add PBFT StratMining. start --Agzs
	if pbft, ok := s.engine.(*pbft.PBFT); ok {
		wallet, err := s.accountManager.Find(accounts.Account{Address: eb})
		if wallet == nil || err != nil {
			log.Error("Etherbase account unavailable locally", "err", err)
			return fmt.Errorf("singer missing: %v", err)
		}
		pbft.Authorize(eb, wallet.SignHash)
	}
	//=>add PBFT StratMining. end --Agzs

	...
	go s.miner.Start(eb)
	return nil
}
```
* è§£å†³æ–¹æ³•ï¼š

å…¶ä»–signerèŠ‚ç‚¹è¿è¡Œminer.start()

### 10ã€å…¶ä»–èŠ‚ç‚¹å¤„ç†æ¶ˆæ¯åï¼Œåªå‘ä¸»èŠ‚ç‚¹å›å¤æ¶ˆæ¯ï¼Œæ²¡æœ‰å‘p2på…¶ä»–çš„peerå¹¿æ’­

ä¸»èŠ‚ç‚¹å¯ä»¥å‘å…¶ä»–æ‰€æœ‰peerå¹¿æ’­ï¼Œsigner1:
```go
INFO [11-04|23:01:43] peer broadcast msg                       peer=4a3de4861cca1453 send msg's hash:=cf1a9bâ€¦818e4d
INFO [11-04|23:01:43] peer.SendMsg() start                     pbftMessageType=*types.PrePrepare
INFO [11-04|23:01:43] p2p sends message!!! before writeMsg()   msgsize=650 msgcode=17
INFO [11-04|23:01:43] WriteMsg()                               msg.Code=17 offset=16

INFO [11-04|23:01:43] peer broadcast msg                       peer=032d933d9b02b13a send msg's hash:=cf1a9bâ€¦818e4d
INFO [11-04|23:01:43] peer.SendMsg() start                     pbftMessageType=*types.PrePrepare
INFO [11-04|23:01:43] p2p sends message!!! before writeMsg()   msgsize=650 msgcode=17
INFO [11-04|23:01:43] WriteMsg()                               msg.Code=17 offset=16

INFO [11-04|23:01:43] peer broadcast msg                       peer=906b7ebc5c0f0f5e send msg's hash:=cf1a9bâ€¦818e4d
INFO [11-04|23:01:43] peer.SendMsg() start                     pbftMessageType=*types.PrePrepare
INFO [11-04|23:01:43] p2p sends message!!! before writeMsg()   msgsize=650 msgcode=17
INFO [11-04|23:01:43] WriteMsg()                               msg.Code=17 offset=16
INFO [11-04|23:01:43] pm.BroadcastMsg() end------------ 
```
è€Œå…¶ä»–signeråªèƒ½å‘ä¸»èŠ‚ç‚¹å¹¿æ’­ï¼Œæ¯”å¦‚signer2èŠ‚ç‚¹ï¼š
```go
INFO [11-04|23:01:43] handleMsg() ---PrePrepareMsg----------- 
INFO [11-04|23:01:43] send preprepare_message to pm.pbftmanager.Queue() 
2017/11/04 23:01:43 Replica 1 processing event
2017/11/04 23:01:43 Replica 1 received incoming message from 0
INFO [11-04|23:01:43] recvMsg() test                           sendID=0 code=1 payload=*types.PrePrepare
2017/11/04 23:01:43 Replica 1 processing event
2017/11/04 23:01:43 Replica 1 received pre-prepare from replica 0 for view=0/seqNo=9
INFO [11-04|23:01:43] Replica storing block in outstanding block store Replica(PeerID)=1 hash=738efcâ€¦270394

2017/11/04 23:01:43 Backup 1 broadcasting prepare for view=0/seqNo=9
2017/11/04 23:01:43 Replica 1 received prepare from replica 1 for view=0/seqNo=9
2017/11/04 23:01:43 Replica 1 prepare count for view=0/seqNo=9: 1
2017/11/04 23:01:43 Replica 1 prepare count for view=0/seqNo=9: 1
2017/11/04 23:01:43 send msg to commChan!

INFO [11-04|23:01:43] pm.BroadcastMsg() start------------ 
INFO [11-04|23:01:43] peer broadcast msg                       peer=e29caed3b331495a send msg's hash:=a912a3â€¦0f22d3
INFO [11-04|23:01:43] peer.SendMsg() start                     pbftMessageType=*types.Prepare
INFO [11-04|23:01:43] p2p sends message!!! before writeMsg()   msgsize=40  msgcode=18
INFO [11-04|23:01:43] WriteMsg()                               msg.Code=18 offset=16
INFO [11-04|23:01:43] pm.BroadcastMsg() end------------ 
```
ä¸»èŠ‚ç‚¹(signer1)å¯ä»¥æ”¶åˆ°å…¶ä»–ä¸‰ä¸ªsignerçš„prepareï¼Œç„¶åå‘å‡ºcommit,å…¶ä»–signerèƒ½æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„commitï¼Œä½†æ˜¯signeräº’ç›¸ä¹‹é—´å´æ”¶ä¸åˆ°å„è‡ªçš„prepare,å¯¼è‡´å…¶ä»–signeræ— æ³•å‘é€è‡ªå·±çš„commitï¼Œä¼šè¿›ä¸€æ­¥è§¦å‘viewchangeã€‚

* é—®é¢˜åŸå› :

å…¶ä»–signeréƒ½åªæ˜¯å’Œsigner1å»ºç«‹äº†è”ç³»ï¼Œä½†æ˜¯äº’ç›¸ä¹‹é—´æ²¡æœ‰å»ºç«‹è”ç³».


* è§£å†³æ–¹æ³•ï¼š

ä½¿ç”¨admin.addPeer("")è¿›è¡Œæ·»åŠ ï¼Œæ¯”å¦‚æœ‰å››ä¸ªsignerï¼Œåˆ†åˆ«ä¸ºsigner1ã€signer2ã€signer3ã€signer4ï¼Œsigner1ä¸ºä¸»èŠ‚ç‚¹ï¼š

éœ€è¦åœ¨`signer2`ã€`signer3`ã€`signer4`ç»ˆç«¯éƒ½è¿è¡Œ`admin.addPeer("encode://...signer1_encode...")`

éœ€è¦åœ¨`signer3`ã€`signer4`ç»ˆç«¯éƒ½è¿è¡Œ`admin.addPeer("encode://...signer2_encode...")`

éœ€è¦åœ¨`signer4`ç»ˆç«¯éƒ½è¿è¡Œ`admin.addPeer("encode://...signer3_encode...")`

ä¿®æ”¹ä¸Šè¿°é”™è¯¯åï¼ŒèŠ‚ç‚¹é—´éƒ½èƒ½æ”¶åˆ°commitï¼Œä½†æ˜¯åœ¨recvCommit()å‡½æ•°å†…å­˜åœ¨é”™è¯¯ã€‚ã€‚ã€‚

### 11ã€recvCommit()é—®é¢˜

åœ¨pbft-core.goä¸­ï¼ŒrecvCommit()å‡½æ•°ä¸­ï¼Œåªèƒ½æ‰“å°å‡º`recvCommit(1) --executeOutstanding()`
```go
instance.executeOutstanding()                      ////xiaobei
		log.Info("recvCommit(1) --executeOutstanding()")   //=>test. --Agzs
		instance.helper.manager.Queue() <- execDoneEvent{} ////xiaobei
		log.Info("recvCommit(2) --send execDoneEvent")     //=>test. --Agzs
		instance.finishedChan <- struct{}{}                /// inform PBFT consensus is reached.  --Zhiguo
		log.Info("recvCommit(3) --finished")               //=>test. --Agzs

```

* åŸå› 

`instance.helper.manager.Queue() <- execDoneEvent{}`è¯­å¥å‘Queue()ä¸­å‘é€äº‹ä»¶ï¼Œè¯¥å‡½æ•°è¿”å›å€¼ä¸ºchannelç±»å‹ï¼Œä¸€æ¬¡åªèƒ½å­˜å‚¨ä¸€ä¸ªäº‹ä»¶ã€‚è¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨æ‹¥æŒ¤æˆ–æŠ¢å ï¼Œæœ‰çš„äº‹ä»¶å¯èƒ½æ— æ³•æŒ¤è¿›è¯¥channelï¼Œæˆ–è€…å‘é€åˆ°channelä¸­ï¼Œåˆšå¼€å§‹è¦å¤„ç†ï¼Œåˆè¢«å…¶ä»–äº‹ä»¶æŠ¢å äº†ã€‚ï¼ˆæ³¨ï¼šä»¥ä¸Šåªæ˜¯çŒœæƒ³ï¼Œç”±äºgoroutineçš„å­˜åœ¨ï¼Œæƒ…å†µä¸å¥½åˆ¤å®šï¼‰

* è§£å†³æ–¹æ³•

å°†`execDoneEvent{}`è§¦å‘çš„æ“ä½œï¼Œç§»åˆ°æ­¤å¤„ï¼Œåœ¨processEvent()ä¸­çš„æ³¨é‡Šæ‰ï¼š
```go
                instance.executeOutstanding()                    ////xiaobei
		log.Info("recvCommit(1) --executeOutstanding()") //=>test. --Agzs
		//============================
		//instance.helper.manager.Queue() <- execDoneEvent{} ////xiaobei
		instance.execDoneSync()
		log.Info("execDoneSync() end") //=>test. --Agzs
		if instance.skipInProgress {
			instance.retryStateTransfer(nil)
			log.Info("retryStateTransfer() end") //=>test. --Agzs
		}
		//=========================
		log.Info("recvCommit(2) --send execDoneEvent") //=>test. --Agzs
		instance.finishedChan <- struct{}{}            /// inform PBFT consensus is reached.  --Zhiguo
		log.Info("recvCommit(3) --finished")           //=>test. --Agzs
```
é—®é¢˜è§£å†³ï¼Œå¹¶ä¸”signer1æˆåŠŸæŒ–å‡ºåŒºå—1ï¼š
```go
INFO [11-05|20:53:51] recvCommit(1) --executeOutstanding() 
INFO [11-05|20:53:51] execDoneSync() 
2017/11/05 20:53:51 Replica 0 had execDoneSync called, flagging ourselves as out of date
2017/11/05 20:53:51 Replica 0 attempting to executeOutstanding
2017/11/05 20:53:51 Replica 0 certstore map[{v:0 n:3}:0xc436d02720]
INFO [11-05|20:53:51] execDoneSync() end 
2017/11/05 20:53:51 Replica 0 has no targets to attempt state transfer to, delaying
INFO [11-05|20:53:51] retryStateTransfer() end 
INFO [11-05|20:53:51] recvCommit(2) --send execDoneEvent 
INFO [11-05|20:53:51] recvCommit(3) --finished 
INFO [11-05|20:53:51] Successfully sealed new block            number=1 hash=a7c286â€¦300942

...
INFO [11-05|20:53:51] ğŸ”¨ mined potential block                  number=1 hash=a7c286â€¦300942

...
INFO [11-05|20:53:51] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=437.671Âµs
```
ä½†æ˜¯ï¼Œå…¶ä»–signerå´æç¤ºâ€œDiscarded bad propagated blockâ€ï¼Œè§é—®é¢˜9ã€‚

### 12ã€rocksDBé”™è¯¯(å¼ºåˆ¶é€€å‡ºé€ æˆçš„é—®é¢˜ï¼‰

```go
panic: Error opening DB: IO error: lock /home/zhiguo/hyperledgerRocksDB/signer1/db/LOCK: Resource temporarily unavailable
```
* åŸå› 

ç»ˆç«¯è¿è¡Œæ—¶ï¼Œæ²¡æœ‰æ­£å¸¸é€€å‡ºï¼Œå¯¼è‡´rocksDBå…³é—­çš„â€å–„åâ€œå·¥ä½œæ²¡æœ‰è¿›è¡Œã€‚

å¼ºåˆ¶é€€å‡ºï¼š
```go
> exit
INFO [11-05|11:30:03] IPC endpoint closed: /home/zhiguo/pbft/signer2/data/geth.ipc 
INFO [11-05|11:30:03] Blockchain manager stopped 
INFO [11-05|11:30:03] Stopping Ethereum protocol 
INFO [11-05|11:30:03] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|11:30:03] Read the next message from the remote peer in pm.handleMsg() returns error 
INFO [11-05|11:30:03] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|11:30:03] Read the next message from the remote peer in pm.handleMsg() returns error 
^C
INFO [11-05|11:30:41] Got interrupt, shutting down... 
^Z
[1]+  Stopped                 geth --datadir ./data --networkid 55661 --pbftid 1 --port 2003 --unlock c28e9d79dfa4a291cbf7422f4ba82fa59e710bc4 console

```

æ­£å¸¸é€€å‡ºï¼š
```go
> exit
INFO [11-05|11:21:42] IPC endpoint closed: /home/zhiguo/pbft/signer2/data/geth.ipc 
INFO [11-05|11:21:42] Blockchain manager stopped 
INFO [11-05|11:21:42] Stopping Ethereum protocol 
INFO [11-05|11:21:42] Ethereum protocol stopped 
INFO [11-05|11:21:42] Transaction pool stopped 
INFO [11-05|11:21:42] Database closed                          database=/home/zhiguo/pbft/signer2/data/geth/chaindata
2017/11/05 11:21:42 RocksDB closed!
```
æ¯”è¾ƒå‘ç°ï¼Œ`IPC`å’Œ`Blockchain manager`å‡æ­£å¸¸å…³é—­ï¼Œ`Ethereum protocol`ã€`Transaction pool`ã€`Database`å‡æœªæ­£å¸¸å…³é—­ã€‚

* è§£å†³æ–¹æ³•

ç›´æ¥æ€æ­»è¿›ç¨‹ï¼š

åœ¨ç»ˆç«¯è¿è¡Œ`ps`æŒ‡ä»¤ï¼š
```go
ethtest@ethtest:~/pbft$ ps
  PID TTY          TIME CMD
21553 pts/23   00:00:00 bash
23747 pts/23   00:00:01 geth
23908 pts/23   00:00:00 ps
```
å¼ºåˆ¶æ€æ­»è¿›ç¨‹23747ï¼š
```go
ethtest@ethtest:~/pbft$ sudo kill -9 23747
[1]+  Killed                  geth --datadir pbft/signer1/data --networkid 55661 --port 2000  (wd: ~)
(wd now: ~/pbft)

```
ä»¥ä¸‹æ˜¯ä¹‹å‰çš„è§£å†³æ–¹æ³•ï¼Œæ¯”è¾ƒç¬¨ï¼Œå¯ç›´æ¥è·³è¿‡åˆ°ä¸‹ä¸€ä¸ªé—®é¢˜ã€‚

~ç›®å‰æ²¡æœ‰æœ‰æ•ˆçš„è§£å†³æ–¹æ³•ï¼Œåªèƒ½æ‰¾åˆ°ç›¸å…³dbæ–‡ä»¶å¤¹ï¼Œåˆ é™¤ä¹‹ã€‚~

åˆ é™¤ä¹‹åï¼ŒrocksDBæ²¡æœ‰é—®é¢˜äº†ï¼ŒlevelDBåˆå‡ºç°é—®é¢˜äº†

```go
INFO [11-05|16:29:09] Starting peer-to-peer node               instance=Geth/v1.6.7-stable/linux-amd64/go1.8.3
2017/11/05 16:29:09 Is db path [/home/zhiguo/hyperledgerRocksDB/signer3/db] empty [false]
2017/11/05 16:29:09 Setting rocksdb maxLogFileSize to 10485760
2017/11/05 16:29:09 Setting rocksdb keepLogFileNum to 10
2017/11/05 16:29:09 Setting rocks db InfoLogLevel to 2
INFO [11-05|16:29:09] Allocated cache and file handles         database=/home/zhiguo/pbft/signer2/data/geth/chaindata cache=128 handles=1024
Fatal: Error starting protocol stack: resource temporarily unavailable
```
ç»§ç»­å°†ç›¸å…³æ–‡ä»¶åˆ é™¤ï¼Œ åˆæç¤ºï¼š
```go
INFO [11-05|16:34:50] init protocol manager and commChan in NewProtocolManager()! replica=3
INFO [11-05|16:34:50] Starting P2P networking 
Fatal: Error starting protocol stack: listen udp :2005: bind: address already in use
```
æœ€ç»ˆï¼Œåªèƒ½å°†signerç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ é™¤ï¼Œé‡æ–°åˆ›å»ºè´¦æˆ·ï¼Œåˆå§‹åŒ–çš„åˆ›ä¸–åŒºå—ã€‚ã€‚ã€‚ã€‚ã€‚

æ­¤å¤–ï¼Œ `pbft.json`éœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åˆ é™¤åé‡æ–°ç”Ÿæˆï¼‰ï¼Œå¦‚æœè¿›è¡Œä¿®æ”¹çš„è¯ï¼Œéœ€è¦ä¿®æ”¹ä¸¤éƒ¨åˆ†ï¼š

1ï¼‰æˆæƒèŠ‚ç‚¹éƒ¨åˆ†
```go
"extraData": "0x0000000000000000000000000000000000000000000000000000000000000000
557afdbcc81c0199305ebbc61580eb0b17be7fdb
575b73df85e22751c143e839ac90c04796463b2f
c28e9d79dfa4a291cbf7422f4ba82fa59e710bc4
73ab48254894b1b645e37bbeec2c55d6c5bd6b04 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
```
è¿™æ˜¯å››ä¸ªæˆæƒçš„è´¦æˆ·ï¼Œéœ€è¦æ¢æˆæ–°åˆ›å»ºçš„è´¦æˆ·ã€‚(ä¸ºäº†è§‚å¯Ÿæ–¹ä¾¿ï¼Œæˆ‘å¯¹å››ä¸ªè´¦æˆ·æ·»åŠ äº†æ¢è¡Œï¼ŒåŸæ–‡ä»¶ä¸­å››ä¸ªè´¦æˆ·çš„åœ°å€éƒ½æ˜¯è¿è½½ä¸€èµ·çš„)

2ï¼‰é¢„è®¾è´¦æˆ·ä½™é¢éƒ¨åˆ†
```go
 "575b73df85e22751c143e839ac90c04796463b2f": {
      "balance": "0x200000000000000000000000000000000000000000000000000000000000000"
    },
 "c4006961eda5b91c38fd93ee6021679f25b97410": {
      "balance": "0x200000000000000000000000000000000000000000000000000000000000000"
    }
```
å…¶ä¸­575ä¸ºsigner1çš„è´¦æˆ·åœ°å€ï¼Œc40ä¸ºnode1åœ°å€.

### 13ã€æ— æ³•æ­£å¸¸é€€å‡º
```go
> exit
INFO [11-05|17:39:23] IPC endpoint closed: /home/zhiguo/pbft/signer1/data/geth.ipc 
INFO [11-05|17:39:23] Blockchain manager stopped 
INFO [11-05|17:39:23] Stopping Ethereum protocol 
INFO [11-05|17:39:23] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|17:39:23] Read the next message from the remote peer in pm.handleMsg() returns error 
INFO [11-05|17:39:23] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|17:39:23] Read the next message from the remote peer in pm.handleMsg() returns error 
WARN [11-05|17:45:09] System clock seems off by -12.297202182s, which can prevent network connectivity 
WARN [11-05|17:45:09] Please enable network time synchronisation in system settings. 
WARN [11-05|18:05:52] System clock seems off by -12.302529327s, which can prevent network connectivity 
WARN [11-05|18:05:52] Please enable network time synchronisation in system settings. 
WARN [11-05|18:17:04] System clock seems off by -12.301364649s, which can prevent network connectivity 
WARN [11-05|18:17:04] Please enable network time synchronisation in system settings. 
WARN [11-05|18:39:11] System clock seems off by -12.291644646s, which can prevent network connectivity 
WARN [11-05|18:39:11] Please enable network time synchronisation in system settings. 
WARN [11-05|18:54:23] System clock seems off by -12.275869174s, which can prevent network connectivity 
WARN [11-05|18:54:23] Please enable network time synchronisation in system settings. 
WARN [11-05|19:05:01] System clock seems off by -12.28059504s, which can prevent network connectivity 
WARN [11-05|19:05:01] Please enable network time synchronisation in system settings. 

```
ä¸€ç›´åœé¡¿åœ¨è¿™ã€‚ã€‚ã€‚

* åŸå› æœªçŸ¥ï¼Œç›®å‰æš‚æ—¶æœªé‡æ–°é‡åˆ°ï¼Œä¸€èˆ¬åœé¡¿20så·¦å³å°±æ­£å¸¸é€€å‡ºäº†ã€‚
* è§£å†³æ–¹æ³•

æ³•1ï¼šè¿ç»­æŒ‰10æ¬¡ `ctrl + C`,æŠ¥é”™é€€å‡ºã€‚è™½ç„¶æ˜¯ç¬¨æ–¹æ³•ï¼Œä½†æ˜¯é‡æ–°è¿è¡Œgeth consoleä¸ä¼šé‡åˆ°**é”™è¯¯(12)**

æ³•2ï¼šå¼ºåˆ¶é€€å‡ºï¼Œç±»ä¼¼é—®é¢˜7çš„è§£å†³æ–¹æ³•

### 14ã€åŒæ­¥åŒºå—æ¨¡å¼é—®é¢˜

signer1æˆåŠŸæŒ–å‡ºåŒºå—1ï¼š
```go
INFO [11-05|20:53:51] recvCommit(1) --executeOutstanding() 
INFO [11-05|20:53:51] execDoneSync() 
2017/11/05 20:53:51 Replica 0 had execDoneSync called, flagging ourselves as out of date
2017/11/05 20:53:51 Replica 0 attempting to executeOutstanding
2017/11/05 20:53:51 Replica 0 certstore map[{v:0 n:3}:0xc436d02720]
INFO [11-05|20:53:51] execDoneSync() end 
2017/11/05 20:53:51 Replica 0 has no targets to attempt state transfer to, delaying
INFO [11-05|20:53:51] retryStateTransfer() end 
INFO [11-05|20:53:51] recvCommit(2) --send execDoneEvent 
INFO [11-05|20:53:51] recvCommit(3) --finished 
INFO [11-05|20:53:51] Successfully sealed new block            number=1 hash=a7c286â€¦300942

...
INFO [11-05|20:53:51] ğŸ”¨ mined potential block                  number=1 hash=a7c286â€¦300942

...
INFO [11-05|20:53:51] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=437.671Âµs
```
ä½†æ˜¯ï¼Œå…¶ä»–signerå´æç¤ºï¼š
```go
INFO [11-05|20:53:51] recvCommit(1) --executeOutstanding() 
INFO [11-05|20:53:51] execDoneSync() 
2017/11/05 20:53:51 Replica 1 had execDoneSync called, flagging ourselves as out of date
2017/11/05 20:53:51 Replica 1 attempting to executeOutstanding
2017/11/05 20:53:51 Replica 1 certstore map[{v:0 n:3}:0xc4368ab860]
INFO [11-05|20:53:51] execDoneSync() end 
2017/11/05 20:53:51 Stopping timer
INFO [11-05|20:53:51] send commit_message to pm.pbftmanager.Queue() 
2017/11/05 20:53:51 Replica 1 has no targets to attempt state transfer to, delaying
INFO [11-05|20:53:51] retryStateTransfer() end 
INFO [11-05|20:53:51] recvCommit(2) --send execDoneEvent 
INFO [11-05|20:53:51] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|20:53:51] handleMsg() ---NewBlockMsg----------- 
INFO [11-05|20:53:51] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|20:53:51] handleMsg() ---NewBlockHashesMsg----------- 
WARN [11-05|20:53:51] Discarded bad propagated block           number=1 hash=a7c286â€¦300942
INFO [11-05|20:53:52] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-05|20:53:52] handleMsg() ---NewBlockMsg----------- 
WARN [11-05|20:53:52] Discarded bad propagated block           number=1 hash=a7c286â€¦300942
```

* åŸå› 

```go
func NewProtocolManager(config *params.ChainConfig, mode downloader.SyncMode, networkId uint64, maxPeers int, mux *event.TypeMux, txpool txPool, engine consensus.Engine, blockchain *core.BlockChain, chaindb ethdb.Database) (*ProtocolManager, error) {
	// Create the protocol manager with the base fields
	manager := &ProtocolManager{
		...
	}

	...
	// Figure out whether to allow fast sync or not
	if mode == downloader.FastSync && blockchain.CurrentBlock().NumberU64() > 0 {
		log.Warn("Blockchain not empty, fast sync disabled")
		mode = downloader.FullSync
	}
	if mode == downloader.FastSync {
		manager.fastSync = uint32(1)
	}

	...
	inserter := func(blocks types.Blocks) (int, error) {
		// If fast sync is running, deny importing weird blocks
		if atomic.LoadUint32(&manager.fastSync) == 1 {
			log.Warn("Discarded bad propagated block", "number", blocks[0].Number(), "hash", blocks[0].Hash())
			return 0, nil
		}
		atomic.StoreUint32(&manager.acceptTxs, 1) // Mark initial sync done on any fetcher import
		return manager.blockchain.InsertChain(blocks)
	}
	manager.fetcher = fetcher.New(blockchain.GetBlockByHash, validator, manager.BroadcastBlock, heighter, inserter, manager.removePeer)

	return manager, nil
}
```
manager.fastSyncè¢«è®¾ç½®ä¸º1äº†ï¼Œè¿™æ˜¯ethereumçš„é»˜è®¤é…ç½®ã€‚ç»æŸ¥æ‰¾ä»£ç å‘ç°ï¼Œåªæœ‰æ‰§è¡Œ`inserter`å‡½æ•°æ‰ä¼šæç¤º`Discarded bad propagated block`ï¼Œè€Œ`inserter`å‡½æ•°è¢«èµ‹å€¼ç»™`Fetcher.insertChain`ï¼Œæœ€ç»ˆåœ¨insert()ä¸­è¢«è°ƒç”¨ï¼š
```go
func (f *Fetcher) insert(peer string, block *types.Block) {
	hash := block.Hash()

	// Run the import on a new thread
	log.Debug("Importing propagated block", "peer", peer, "number", block.Number(), "hash", hash)
	go func() {
		...
		if _, err := f.insertChain(types.Blocks{block}); err != nil {
			log.Debug("Propagated block import failed", "peer", peer, "number", block.Number(), "hash", hash, "err", err)
			return
		}
		// If import succeeded, broadcast the block
		propAnnounceOutTimer.UpdateSince(block.ReceivedAt)
		go f.broadcastBlock(block, false)

		// Invoke the testing hook if needed
		if f.importedHook != nil {
			f.importedHook(block)
		}
	}()
}
```

æµ‹è¯•cliqueçš„æ—¶å€™ï¼Œé‡åˆ°åŒæ ·çš„é—®é¢˜ï¼Œå…·ä½“åŸå› æœªçŸ¥ï¼Œä½†æ˜¯åœ¨cliqueä¸­ä»»æ„ä¸¤ä¸ªç‚¹è¿è¡Œ`admin.addPeer()`ï¼Œä¸¤ä¸¤äº’è”åï¼Œè¯¥é—®é¢˜æ¶ˆå¤±ã€‚

åç»§ç»­æŸ¥æ‰¾åŸå› ï¼Œå‘ç°`pbft`ä¸­ä½¿ç”¨äº†cliqueä¸­çš„`snap.Recents`ï¼Œè¯¥å˜é‡ç”¨äºæ ‡è®°æœ€è¿‘ç­¾åçš„`signer`ï¼Œå¦‚æœè¯¥`signer`è¿‘æœŸç­¾è¿‡åï¼ŒåæœŸä¾¿ä¸èƒ½å†æ¬¡ç­¾åï¼Œä¼šè¿”å›`errUnauthorized`ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªåœ°æ–¹å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼ˆæ·»åŠ æ³¨é‡Šéƒ¨åˆ†ï¼‰ï¼š
```go
func (c *PBFT) verifySeal(chain consensus.ChainReader, header *types.Header, parents []*types.Header) error {
	...
	// for seen, recent := range snap.Recents {
	// 	if recent == signer {
	// 		// Signer is among recents, only fail if the current block doesn't shift it out
	// 		if limit := uint64(len(snap.Signers)/2 + 1); seen > number-limit {
	// 			return errUnauthorized
	// 		}
	// 	}
	// }
	// Ensure that the difficulty corresponds to the turn-ness of the signer
	inturn := snap.inturn(header.Number.Uint64(), signer)
	if inturn && header.Difficulty.Cmp(diffInTurn) != 0 {
		return errInvalidDifficulty
	}
	if !inturn && header.Difficulty.Cmp(diffNoTurn) != 0 {
		return errInvalidDifficulty
	}
	return nil
}
```
```go
func (c *PBFT) Seal(chain consensus.ChainReader, block *types.Block, stop <-chan struct{}) (*types.Block, error) {
	...
	//=> --Agzs
	// // If we're amongst the recent signers, wait for the next block
	// for seen, recent := range snap.Recents {
	// 	if recent == signer {
	// 		// Signer is among recents, only wait if the current block doesn't shift it out
	// 		if limit := uint64(len(snap.Signers)/2 + 1); number < limit || seen > number-limit {
	// 			log.Info("Signed recently, must wait for others")
	// 			<-stop
	// 			return nil, nil
	// 		}
	// 	}
	// }

	...
	// Sign all the things!
	sighash, err := signFn(accounts.Account{Address: signer}, sigHash(header, nil).Bytes()) //=> TODO. --Agzs
	...
	newBlock := block.WithSeal(header)
	
	c.pbft.recvRequestBlock(newBlock) 

	/// TODO: wait until the commit messages are received by 2/3 PBFT nodes, then return the block --Zhiguo
	select {
	case <-stop:
		log.Info("Stop PBFT algorithm!")
		return nil, nil
	case <-c.finishedChan:
		//c.pbft.lastExec = newBlock.Header().Number.Uint64() //=>TODO. lastExec. --Agzs
		return newBlock, nil
	}

	///        return nil, nil

}
```
```go
func (s *Snapshot) apply(headers []*types.Header) (*Snapshot, error) {
	...
		// for _, recent := range snap.Recents {
		// 	if recent == signer {
		// 		return nil, errUnauthorized
		// 	}
		// }
	...
}

```
ç”±äºè¿”å›äº†`errUnauthorized`ï¼Œå…¶åè¯­å¥æ— æ³•æ­£å¸¸è¿›è¡Œï¼Œæ‰€ä»¥ä¼šé€ æˆè¯¥é”™è¯¯ã€‚

* è§£å†³æ–¹æ³•

æ³¨é‡Šæ‰ä¸Šè¿°ä¸‰ä¸ªåœ°æ–¹çš„`snap.Recents`ä¸­è¿”å›`errUnauthorized`çš„forå¾ªç¯ï¼Œå¦‚ä¸Šæ‰€ç¤ºã€‚

è§£å†³æ‰ä¸Šè¿°é—®é¢˜åï¼Œsigner1å¯ä»¥è¿ç»­æŒ–å—ï¼Œå…¶ä»–signerä¹Ÿå¯ä»¥importè¿™äº›åŒºå—ï¼ŒåŒ…æ‹¬åŠ å…¥é€šè¿‡addPeer()æ·»åŠ çš„nodeä¹Ÿå¯ä»¥importã€‚

**æ³¨æ„ï¼š**

å»ºè®®è¿è¡Œå‰åˆ é™¤å­˜å‚¨`rocksDB`çš„`db`æ–‡ä»¶å¤¹ï¼Œå› ä¸ºè¿è¡Œæµ‹è¯•çš„è¿‡ç¨‹ä¸­å¿…å®šå­˜åœ¨é”™è¯¯ï¼Œè€Œä¸€äº›é”™è¯¯çš„`preprepare`ç­‰å…¶ä»–æ¶ˆæ¯å°†ä¼šä¿å­˜åˆ°`pset`å’Œ`qset`ï¼Œç„¶åè¿›ä¸€æ­¥ä¿å­˜åˆ°`rocksDB`ï¼Œé‡æ–°å¯åŠ¨åï¼Œè¿™äº›æ•°æ®éƒ½ä¼šè¢«é‡æ–°è¯»å–ï¼Œå¯¼è‡´ä¸€äº›`seqNo`å‡ºç°é”™è¯¯ï¼Œç¨‹åºæ— æ³•æ­£å¸¸è¿è¡Œï¼Œä¸€å®šè¦æ³¨æ„è¿™ä¸€ç‚¹ï¼ï¼ï¼ï¼ï¼ï¼

### 15ã€æƒé™é—®é¢˜

åœ¨**é—®é¢˜14æ²¡è§£å†³**çš„åŸºç¡€ä¸Šï¼ŒçŒœæƒ³é—®é¢˜9è§£å†³åï¼Œè¯¥é—®é¢˜åº”è¯¥ä¼šè§£å†³ã€‚

å…³é—­å„ç»ˆç«¯ï¼Œç„¶åé‡æ–°è¿è¡Œgethï¼Œåˆé‡åˆ°æ–°é—®é¢˜ï¼š

signer1æŠ¥é”™ï¼š
```go
INFO [11-06|10:57:37] Successfully sealed new block            number=2 hash=205067â€¦39e5d8
INFO [11-06|10:57:37] ğŸ”¨ mined potential block                  number=2 hash=205067â€¦39e5d8
ERROR[11-06|10:57:37] Failed to prepare header for mining      err=unauthorized
```
signer2æŠ¥é”™ï¼Œå…¶ä»–signerç±»ä¼¼ï¼š
```go
INFO [11-06|10:57:37] Imported new chain segment               blocks=1 txs=0 mgas=0.000 elapsed=220.297Âµs mgasps=0.000 number=2 hash=205067â€¦39e5d8
ERROR[11-06|10:57:37] Failed to prepare header for mining      err=unauthorized
```
å¦‚æœæ­£å¸¸çš„è¯ï¼Œsigner2åº”è¯¥importçš„blocksçš„æ•°ç›®ä¸º2ï¼Œå¹¶ä¸”signer1ä¸ä¼šå‡ºç°æœªæˆæƒæƒ…å†µã€‚

**æµ‹è¯•cliqueæ­£å¸¸è¿è¡Œæƒ…å†µ**ï¼š

signer1è¿è¡Œç»“æœï¼š
```go
> miner.start()
INFO [11-06|11:10:10] Transaction pool price threshold updated price=18000000000
INFO [11-06|11:10:10] Starting mining operation 
null
> INFO [11-06|11:10:10] Commit new mining work                   number=22 txs=0 uncles=0 elapsed=113.333Âµs
INFO [11-06|11:10:10] Successfully sealed new block            number=22 hash=af7e9bâ€¦d34f0c
INFO [11-06|11:10:10] ğŸ”¨ mined potential block                  number=22 hash=af7e9bâ€¦d34f0c
INFO [11-06|11:10:10] Commit new mining work                   number=23 txs=0 uncles=0 elapsed=408.973Âµs
> admin.addPeer("enode://996058eac555decf228b31699553d28fb1f65fb116f6d98b18b9f42d4d65498a4f9db808ace34211e3b7fad627f028f6c7fdd39b745aa3cdca2ca367ac51b362@127.0.0.1:2000")
INFO [11-06|11:10:20] Successfully sealed new block            number=23 hash=0c3286â€¦2bd8eb
INFO [11-06|11:10:20] ğŸ”¨ mined potential block                  number=23 hash=0c3286â€¦2bd8eb
INFO [11-06|11:10:20] Commit new mining work                   number=24 txs=0 uncles=0 elapsed=391.673Âµs
INFO [11-06|11:10:30] Successfully sealed new block            number=24 hash=383202â€¦0d2002
INFO [11-06|11:10:30] ğŸ”¨ mined potential block                  number=24 hash=383202â€¦0d2002
INFO [11-06|11:10:30] Commit new mining work                   number=25 txs=0 uncles=0 elapsed=379.078Âµs

true
```
node1è¿è¡Œç»“æœï¼š
```go
INFO [11-06|11:10:38] Imported new chain segment               blocks=4 txs=0 mgas=0.000 elapsed=1.844ms mgasps=0.000 number=24 hash=383202â€¦0d2002 ignored=4
INFO [11-06|11:10:40] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-06|11:10:40] handleMsg() ---NewBlockMsg----------- 
INFO [11-06|11:10:40] Read the next message from the remote peer in pm.handleMsg() 
INFO [11-06|11:10:40] handleMsg() ---NewBlockHashesMsg----------- 
INFO [11-06|11:10:40] Imported new chain segment               blocks=1 txs=0 mgas=0.000 elapsed=292.206Âµs mgasps=0.000 number=25 hash=c0e8f4â€¦e9449d

```

* è§£å†³æ–¹æ³•
é—®é¢˜14è§£å†³åï¼Œè¯¥é—®é¢˜ä¸å­˜åœ¨ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚

